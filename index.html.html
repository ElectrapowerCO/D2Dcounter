<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0f">
    <title>D2D Counter</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg-primary: #0a0a0f; --bg-secondary: #12121a; --bg-card: #1a1a24;
            --accent-cyan: #00e5cc; --accent-magenta: #e930ff; --accent-yellow: #f0c000;
            --accent-green: #2ed573; --accent-red: #ff4757;
            --text-primary: #ffffff; --text-secondary: #8a8a9a; --text-dim: #55556a; --border: #2a2a3a;
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); display: flex; flex-direction: column; padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); }
        
        .login-screen { position: fixed; inset: 0; background: var(--bg-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; z-index: 100; }
        .login-screen.hidden { display: none; }
        .login-logo { font-family: 'Space Mono', monospace; font-size: 2.5rem; font-weight: 700; color: var(--accent-cyan); margin-bottom: 0.5rem; }
        .login-subtitle { color: var(--text-dim); margin-bottom: 3rem; font-size: 0.9rem; }
        .login-form { width: 100%; max-width: 320px; }
        .login-label { display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 0.5rem; }
        .login-input { width: 100%; padding: 1rem; background: var(--bg-card); border: 2px solid var(--border); border-radius: 12px; color: var(--text-primary); font-family: 'DM Sans', sans-serif; font-size: 1.1rem; text-align: center; margin-bottom: 1rem; }
        .login-input:focus { outline: none; border-color: var(--accent-cyan); }
        .login-input::placeholder { color: var(--text-dim); }
        .login-btn { width: 100%; padding: 1rem; background: var(--accent-cyan); border: none; border-radius: 12px; color: var(--bg-primary); font-family: 'DM Sans', sans-serif; font-size: 1.1rem; font-weight: 700; cursor: pointer; }
        .login-btn:active { transform: scale(0.98); }
        .login-error { color: var(--accent-red); text-align: center; margin-top: 1rem; font-size: 0.9rem; min-height: 1.5rem; }

        .header { padding: 1rem 1.25rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta)); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700; color: var(--bg-primary); }
        .user-name { font-weight: 600; font-size: 1rem; }
        .logout-btn { background: none; border: 1px solid var(--border); color: var(--text-dim); padding: 0.5rem 0.75rem; border-radius: 8px; font-size: 0.8rem; cursor: pointer; font-family: 'DM Sans', sans-serif; }
        .logout-btn:active { background: var(--bg-card); }

        .sync-status { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); font-size: 0.8rem; color: var(--text-dim); }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green); }
        .sync-dot.syncing { background: var(--accent-yellow); animation: blink 1s infinite; }
        .sync-dot.offline { background: var(--accent-red); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .view-toggle { display: flex; background: var(--bg-secondary); padding: 0.5rem; gap: 0.5rem; }
        .toggle-btn { flex: 1; padding: 0.75rem; background: transparent; border: none; border-radius: 8px; color: var(--text-secondary); font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 600; cursor: pointer; }
        .toggle-btn.active { background: var(--accent-cyan); color: var(--bg-primary); }

        .counter-container { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: calc(1rem + var(--safe-bottom)); }
        .counter-grid { display: flex; flex-direction: column; gap: 0.75rem; }
        .counter-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; display: flex; align-items: center; overflow: hidden; user-select: none; }
        .counter-label { flex: 1; padding: 1.25rem; }
        .counter-name { font-weight: 600; font-size: 1rem; color: var(--text-primary); }
        .counter-subtitle { font-size: 0.75rem; color: var(--text-dim); margin-top: 0.25rem; }
        .counter-value-section { display: flex; align-items: center; }
        .counter-decrement { width: 50px; height: 80px; background: rgba(255, 71, 87, 0.1); border: none; color: var(--accent-red); font-size: 1.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; font-family: 'DM Sans', sans-serif; }
        .counter-decrement:active { background: rgba(255, 71, 87, 0.25); }
        .counter-decrement:disabled { opacity: 0.3; }
        .counter-value { min-width: 70px; padding: 1rem 0.5rem; font-family: 'Space Mono', monospace; font-size: 1.75rem; font-weight: 700; text-align: center; background: var(--bg-secondary); }
        .counter-increment { width: 70px; height: 80px; border: none; color: var(--bg-primary); font-size: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; font-family: 'DM Sans', sans-serif; }
        .counter-increment:active { filter: brightness(1.2); }
        .counter-increment:disabled { opacity: 0.3; }

        .summary-footer { background: var(--bg-secondary); border-top: 1px solid var(--border); padding: 1rem 1.25rem; display: flex; justify-content: space-around; }
        .summary-stat { text-align: center; }
        .summary-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 0.25rem; }
        .summary-value { font-family: 'Space Mono', monospace; font-size: 1.25rem; font-weight: 700; color: var(--accent-cyan); }
        .summary-value.green { color: var(--accent-green); }

        .toast { position: fixed; bottom: calc(100px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--accent-green); border-radius: 8px; padding: 0.75rem 1.25rem; font-size: 0.9rem; z-index: 200; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .toast.show { opacity: 1; }

        .date-display { text-align: center; padding: 0.75rem; background: var(--bg-primary); color: var(--text-dim); font-size: 0.85rem; border-bottom: 1px solid var(--border); }
        .date-display strong { color: var(--text-secondary); }

        .reset-day-btn { width: 100%; margin-top: 1rem; padding: 0.75rem; background: transparent; border: 1px dashed var(--border); border-radius: 12px; color: var(--text-dim); font-family: 'DM Sans', sans-serif; font-size: 0.85rem; cursor: pointer; }
        .reset-day-btn:active { border-color: var(--accent-red); color: var(--accent-red); background: rgba(255, 71, 87, 0.1); }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .pulse { animation: pulse 0.15s ease-out; }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-logo">D2D</div>
        <div class="login-subtitle">Counter App</div>
        <div class="login-form">
            <label class="login-label">Your Name</label>
            <input type="text" class="login-input" id="nameInput" placeholder="Enter your name..." autocomplete="off">
            <label class="login-label">PIN Code</label>
            <input type="password" class="login-input" id="pinInput" placeholder="â€¢â€¢â€¢â€¢" maxlength="6" inputmode="numeric">
            <button class="login-btn" id="loginBtn">Start Counting</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <div class="app" id="mainApp" style="display: none; flex-direction: column; height: 100%;">
        <header class="header">
            <div class="header-left">
                <div class="user-avatar" id="userAvatar">JD</div>
                <span class="user-name" id="userName">John Doe</span>
            </div>
            <button class="logout-btn" id="logoutBtn">Switch</button>
        </header>

        <div class="sync-status">
            <div class="sync-dot" id="syncDot"></div>
            <span id="syncText">Connected</span>
        </div>

        <div class="date-display" id="dateDisplay"><strong>Today</strong></div>

        <div class="view-toggle">
            <button class="toggle-btn active" id="todayBtn">Today</button>
            <button class="toggle-btn" id="allTimeBtn">All Time</button>
        </div>

        <div class="counter-container">
            <div class="counter-grid" id="counterGrid"></div>
            <button class="reset-day-btn" id="resetBtn">ðŸ”„ Reset Today's Counts</button>
        </div>

        <div class="summary-footer">
            <div class="summary-stat"><div class="summary-label">Total</div><div class="summary-value" id="summaryTotal">0</div></div>
            <div class="summary-stat"><div class="summary-label">Doors</div><div class="summary-value" id="summaryDoors">0</div></div>
            <div class="summary-stat"><div class="summary-label">Leads</div><div class="summary-value" id="summaryLeads">0</div></div>
            <div class="summary-stat"><div class="summary-label">Closed</div><div class="summary-value green" id="summaryClosed">0</div></div>
        </div>
    </div>

    <div class="toast" id="toast">Saved!</div>

<script>
(function() {
    var SUPABASE_URL = 'https://uwhirxxjglbjottwogkw.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3aGlyeHhqZ2xiam90dHdvZ2t3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjU2MDgsImV4cCI6MjA4NTgwMTYwOH0.c3lSRd9lpyf7QaxGNkRqwutAK1JvyUOp8a_56qBfkxA';
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    var KPI_FIELDS = [
        { key: 'doors', dbKey: 'doors', label: 'Doors', subtitle: 'Total doors knocked', color: '#00e5cc' },
        { key: 'conversations', dbKey: 'conversations', label: 'Conversations', subtitle: 'People who engaged', color: '#00e5cc' },
        { key: 'convHO', dbKey: 'conv_ho', label: 'Conversations with HO', subtitle: 'Homeowner conversations', color: '#e930ff' },
        { key: 'leads', dbKey: 'leads', label: 'Leads', subtitle: 'Interested prospects', color: '#f0c000' },
        { key: 'appointments', dbKey: 'appointments', label: 'Appointments', subtitle: 'Meetings scheduled', color: '#f0c000' },
        { key: 'seats', dbKey: 'seats', label: 'Seats', subtitle: 'Appointments attended', color: '#2ed573' },
        { key: 'seatsComplete', dbKey: 'seats_complete', label: 'Seats Complete', subtitle: 'Full presentations', color: '#2ed573' },
        { key: 'closed', dbKey: 'closed', label: 'Closed', subtitle: 'Deals closed', color: '#2ed573' },
        { key: 'dq', dbKey: 'dq', label: 'DQ', subtitle: 'Disqualified leads', color: '#ff4757' }
    ];

    var currentWorker = null;
    var currentView = 'today';
    var todayEntry = null;
    var allTimeEntries = [];
    var isSyncing = false;

    function getTodayString() { return new Date().toISOString().split('T')[0]; }
    
    function formatDateDisplay(d) {
        return new Date(d + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    }
    
    function getInitials(name) {
        return name.split(' ').map(function(n) { return n[0]; }).join('').toUpperCase().slice(0, 2);
    }
    
    function showToast(msg) {
        var t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(function() { t.classList.remove('show'); }, 1500);
    }

    function updateSyncStatus(status) {
        var dot = document.getElementById('syncDot');
        var text = document.getElementById('syncText');
        dot.className = 'sync-dot';
        if (status === 'syncing') {
            dot.classList.add('syncing');
            text.textContent = 'Syncing...';
        } else if (status === 'offline') {
            dot.classList.add('offline');
            text.textContent = 'Offline';
        } else {
            text.textContent = 'Connected';
        }
    }

    async function login() {
        var name = document.getElementById('nameInput').value.trim();
        var pin = document.getElementById('pinInput').value.trim();
        var errorEl = document.getElementById('loginError');

        if (!name || !pin) {
            errorEl.textContent = 'Please enter name and PIN';
            return;
        }

        try {
            updateSyncStatus('syncing');
            var result = await supabase.from('workers').select('*').ilike('name', name).eq('pin', pin).eq('is_active', true).single();
            
            if (result.error || !result.data) {
                errorEl.textContent = 'Invalid name or PIN';
                updateSyncStatus('online');
                return;
            }
            
            currentWorker = result.data;
            localStorage.setItem('d2d_worker', JSON.stringify(result.data));
            await showApp();
        } catch (err) {
            errorEl.textContent = 'Connection error. Try again.';
            updateSyncStatus('offline');
        }
    }

    function logout() {
        currentWorker = null;
        localStorage.removeItem('d2d_worker');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('nameInput').value = '';
        document.getElementById('pinInput').value = '';
        document.getElementById('loginError').textContent = '';
    }

    async function showApp() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('userAvatar').textContent = getInitials(currentWorker.name);
        document.getElementById('userName').textContent = currentWorker.name;
        document.getElementById('dateDisplay').innerHTML = '<strong>Today</strong> â€” ' + formatDateDisplay(getTodayString());

        await loadTodayEntry();
        await loadAllTimeEntries();
        renderCounters();
        updateSummary();
        updateSyncStatus('online');
    }

    async function loadTodayEntry() {
        var today = getTodayString();
        try {
            var result = await supabase.from('kpi_entries').select('*').eq('worker_id', currentWorker.id).eq('date', today).single();
            
            if (result.data) {
                todayEntry = result.data;
            } else {
                var insertResult = await supabase.from('kpi_entries').insert([{
                    worker_id: currentWorker.id,
                    date: today,
                    doors: 0, conversations: 0, conv_ho: 0, leads: 0, appointments: 0, seats: 0, seats_complete: 0, closed: 0, dq: 0
                }]).select().single();
                
                if (!insertResult.error) todayEntry = insertResult.data;
            }
        } catch (err) {
            console.error('Error loading today entry:', err);
        }
    }

    async function loadAllTimeEntries() {
        try {
            var result = await supabase.from('kpi_entries').select('*').eq('worker_id', currentWorker.id);
            allTimeEntries = result.data || [];
        } catch (err) {
            console.error('Error loading all entries:', err);
        }
    }

    function getTodayData() {
        if (!todayEntry) return {};
        var data = {};
        KPI_FIELDS.forEach(function(f) {
            data[f.key] = todayEntry[f.dbKey] || 0;
        });
        return data;
    }

    function getAllTimeData() {
        var totals = {};
        KPI_FIELDS.forEach(function(f) { totals[f.key] = 0; });
        allTimeEntries.forEach(function(entry) {
            KPI_FIELDS.forEach(function(f) {
                totals[f.key] += entry[f.dbKey] || 0;
            });
        });
        return totals;
    }

    function switchView(view) {
        currentView = view;
        document.getElementById('todayBtn').classList.toggle('active', view === 'today');
        document.getElementById('allTimeBtn').classList.toggle('active', view === 'allTime');
        renderCounters();
        updateSummary();
    }

    function renderCounters() {
        var container = document.getElementById('counterGrid');
        var data = currentView === 'today' ? getTodayData() : getAllTimeData();
        var disabled = currentView === 'allTime';

        var html = '';
        KPI_FIELDS.forEach(function(f, index) {
            html += '<div class="counter-card" data-key="' + f.key + '" data-index="' + index + '">';
            html += '<div class="counter-label">';
            html += '<div class="counter-name">' + f.label + '</div>';
            html += '<div class="counter-subtitle">' + f.subtitle + '</div>';
            html += '</div>';
            html += '<div class="counter-value-section">';
            html += '<button class="counter-decrement" data-key="' + f.key + '"' + (disabled ? ' disabled' : '') + '>âˆ’</button>';
            html += '<div class="counter-value" id="value_' + f.key + '" style="color:' + f.color + '">' + (data[f.key] || 0) + '</div>';
            html += '<button class="counter-increment" data-key="' + f.key + '" style="background:' + f.color + '"' + (disabled ? ' disabled' : '') + '>+</button>';
            html += '</div></div>';
        });
        container.innerHTML = html;
        
        // Add event listeners for increment/decrement buttons
        document.querySelectorAll('.counter-increment').forEach(function(btn) {
            btn.addEventListener('click', function() {
                updateCounter(this.getAttribute('data-key'), 1);
            });
        });
        document.querySelectorAll('.counter-decrement').forEach(function(btn) {
            btn.addEventListener('click', function() {
                updateCounter(this.getAttribute('data-key'), -1);
            });
        });
    }

    async function updateCounter(key, delta) {
        if (currentView !== 'today' || !todayEntry || isSyncing) return;

        var field = KPI_FIELDS.find(function(f) { return f.key === key; });
        if (!field) return;

        var newValue = Math.max(0, (todayEntry[field.dbKey] || 0) + delta);
        todayEntry[field.dbKey] = newValue;

        var valueEl = document.getElementById('value_' + key);
        valueEl.textContent = newValue;
        valueEl.classList.add('pulse');
        setTimeout(function() { valueEl.classList.remove('pulse'); }, 150);

        if (navigator.vibrate) navigator.vibrate(10);
        updateSummary();

        isSyncing = true;
        updateSyncStatus('syncing');

        try {
            var updateObj = {};
            updateObj[field.dbKey] = newValue;
            updateObj['updated_at'] = new Date().toISOString();

            await supabase.from('kpi_entries').update(updateObj).eq('id', todayEntry.id);
            
            var idx = allTimeEntries.findIndex(function(e) { return e.id === todayEntry.id; });
            if (idx >= 0) {
                allTimeEntries[idx] = Object.assign({}, todayEntry);
            } else {
                allTimeEntries.push(Object.assign({}, todayEntry));
            }

            updateSyncStatus('online');
            showToast(delta > 0 ? '+1 âœ“' : '-1 âœ“');
        } catch (err) {
            console.error('Sync error:', err);
            updateSyncStatus('offline');
            showToast('Offline - will sync');
        }

        isSyncing = false;
    }

    function updateSummary() {
        var data = currentView === 'today' ? getTodayData() : getAllTimeData();
        var total = 0;
        KPI_FIELDS.forEach(function(f) { total += data[f.key] || 0; });
        document.getElementById('summaryTotal').textContent = total;
        document.getElementById('summaryDoors').textContent = data.doors || 0;
        document.getElementById('summaryLeads').textContent = data.leads || 0;
        document.getElementById('summaryClosed').textContent = data.closed || 0;
    }

    async function resetToday() {
        if (currentView !== 'today' || !todayEntry) return;
        if (!confirm('Reset all of today\'s counts to zero?')) return;

        KPI_FIELDS.forEach(function(f) { todayEntry[f.dbKey] = 0; });

        try {
            var updateObj = { updated_at: new Date().toISOString() };
            KPI_FIELDS.forEach(function(f) { updateObj[f.dbKey] = 0; });
            await supabase.from('kpi_entries').update(updateObj).eq('id', todayEntry.id);
            
            renderCounters();
            updateSummary();
            showToast('Reset âœ“');
        } catch (err) {
            showToast('Error resetting');
        }
    }

    window.addEventListener('online', function() { updateSyncStatus('online'); });
    window.addEventListener('offline', function() { updateSyncStatus('offline'); });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Login
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('pinInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        // View toggle
        document.getElementById('todayBtn').addEventListener('click', function() { switchView('today'); });
        document.getElementById('allTimeBtn').addEventListener('click', function() { switchView('allTime'); });
        
        // Reset button
        document.getElementById('resetBtn').addEventListener('click', resetToday);
        
        // Check for saved session
        var saved = localStorage.getItem('d2d_worker');
        if (saved) {
            currentWorker = JSON.parse(saved);
            supabase.from('workers').select('*').eq('id', currentWorker.id).eq('is_active', true).single()
                .then(function(result) {
                    if (result.data) {
                        currentWorker = result.data;
                        showApp();
                    } else {
                        localStorage.removeItem('d2d_worker');
                        currentWorker = null;
                    }
                })
                .catch(function() {
                    showApp(); // Offline, use cached
                });
        }
    });
})();
</script>
</body>
</html>
